#!/bin/sh
set -e

CONFIG=/etc/tor/torrc
DATADIR=/var/lib/tor

touch $CONFIG
chmod 0644 $CONFIG

printenv | grep '^TOR_' | sed -E 's/TOR_([^=]*)=(.*)/\1 \2/' > $CONFIG
cat << EOF >> $CONFIG
SOCKSPort 127.0.0.1:9050
DataDirectory $DATADIR
EOF

chmod -R 0600 $DATADIR
chmod 0700 $DATADIR

chown -R nobody:nogroup $DATADIR

exec s6-setuidgid nobody tor -f $CONFIG
